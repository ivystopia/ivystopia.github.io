#!/bin/sh
# Colorise AWS CLI JSON output when used as AWS_PAGER
# Usage:
#   export AWS_PAGER=aws-color-pager
# Optional:
#   export AWS_COLOR_PAGER_PAGE=1   # force paging
#   export AWS_COLOR_PAGER_PAGE=0   # disable paging (default)

set -eu

PAGE="${AWS_COLOR_PAGER_PAGE:-0}"

tmp="$(mktemp "${TMPDIR:-/tmp}/aws-color-pager.XXXXXX")"
out="$(mktemp "${TMPDIR:-/tmp}/aws-color-pager.XXXXXX")"
trap 'rm -f "$tmp" "$out"' EXIT

# Read all output first so we can validate/transform without consuming stdin.
cat >"$tmp"

# Try to pretty-print + colour once. If it fails, pass through original.
if jq -C . "$tmp" >"$out" 2>/dev/null; then
  if [ "$PAGE" = "1" ] && [ -t 1 ]; then
    less -R <"$out"
  else
    cat "$out"
  fi
else
  if [ "$PAGE" = "1" ] && [ -t 1 ]; then
    less -R <"$tmp"
  else
    cat "$tmp"
  fi
fi
